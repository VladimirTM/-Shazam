import numpy as np
from scipy.fftpack import fft, fftfreq
from numpy import linspace 
import matplotlib.pyplot as plt
import csv
# Opening the csv file in read mode

arduino_samples = []
with open('../../fpga/test/data/inputs/arduino.txt', 'r') as file:
    # Creating a csv reader object
    reader = csv.reader(file)
    for row in reader:
        arduino_samples = list(map(lambda x : int(x), row))

FFT_SIZE = 1024

def try_find_peaks (data, number_of_peaks_to_find):
    peaks = []
    for i in range (0, number_of_peaks_to_find):
        maximum = max(list(data))
        maximum_index = list(data).index(maximum)
        data[maximum_index] = 0
        peaks.append({"value": maximum, "index": maximum_index})
    return peaks

x = linspace(0, FFT_SIZE, FFT_SIZE)[:FFT_SIZE//2]
def make_FFT (samples, sampling_rate, start = 0):
    normalized_samples = samples[start:start + FFT_SIZE - 1];
    
    y = fft(normalized_samples, FFT_SIZE)

    x = fftfreq(1024, 1/sampling_rate)[:FFT_SIZE//2]
    
    magnitude = np.abs(y[:FFT_SIZE // 2])
    return magnitude, x

def plot_FFT(magnitudes, x, title):
    plt.figure()
    plt.xlabel("Frequency (Hz)")
    plt.title(title)
    plt.plot(x, magnitudes, label="Spectrum")
    detected_maximas = np.array(try_find_peaks(magnitudes, 16))
    plt.scatter(np.array(list(map(lambda max_index_pair: max_index_pair["index"], detected_maximas))), list(map(lambda max_index_pair: max_index_pair["value"], detected_maximas)), color="y", zorder=10, label="My Marker")
    return list(sorted(map(lambda max_index_pair: max_index_pair["index"], detected_maximas)))
SAMPLING_RATE = 10_000

print("Length arduino_samples_barely_holding_on_v2", len(arduino_samples))

magnitudes_0, x_0 = make_FFT(arduino_samples, SAMPLING_RATE, 0)
magnitudes_1, x_1 = make_FFT(arduino_samples, SAMPLING_RATE, 511)
max_frequencies_0 = plot_FFT(magnitudes_0, x, "PYTHON FFT FIRST HALF")
max_frequencies_1 = plot_FFT(magnitudes_1, x, "PYTHON FFT SECOND HALF")
print("MAX FREQUENCIES DETECTED IN FIRST HALF:", list(sorted(max_frequencies_0)))
print("MAX FREQUENCIES DETECTED IN SECOND HALF:", list(sorted(max_frequencies_1)))

verilog_magnitudes_first_half = [1023.937500,1023.937500,0.187500,0.125000,0.187500,0.125000,0.125000,0.125000,0.187500,0.187500,0.187500,0.187500,0.125000,0.125000,0.125000,0.187500,0.187500,0.125000,0.125000,0.187500,0.125000,0.187500,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.062500,0.000000,0.187500,1.812500,2.375000,0.687500,0.375000,0.250000,0.250000,0.250000,0.250000,0.187500,0.187500,0.125000,0.000000,0.375000,1.125000,0.750000,1.062500,1.750000,3.125000,6.562500,8.500000,18.750000,21.250000,18.562500,6.250000,3.625000,3.875000,0.687500,1.062500,0.812500,1.437500,1.500000,2.062500,0.875000,2.687500,1.750000,6.250000,45.687500,187.187500,5.437500,4.000000,4.312500,280.750000,102.375000,19.812500,9.875000,2.312500,2.437500,0.312500,0.750000,0.250000,0.000000,1.062500,0.437500,0.750000,0.375000,0.375000,1.312500,1.000000,0.062500,0.312500,0.125000,1.125000,13.125000,0.000000,0.125000,0.000000,0.187500,0.000000,0.625000,0.187500,1.875000,1.125000,11.625000,52.125000,4.375000,68.062500,88.437500,42.500000,168.625000,140.812500,54.437500,18.812500,4.250000,2.625000,0.562500,0.625000,0.687500,0.500000,0.562500,0.312500,0.250000,0.187500,0.125000,0.125000,0.062500,0.062500,0.062500,0.000000,0.062500,0.187500,0.187500,0.125000,0.000000,0.000000,0.000000,0.000000,0.062500,0.062500,0.250000,1.687500,4.375000,7.937500,20.312500,1.500000,0.125000,0.562500,1.312500,0.000000,2.875000,7.750000,0.750000,3.062500,1.562500,0.000000,0.687500,0.562500,0.312500,0.250000,0.375000,0.312500,0.250000,0.312500,0.437500,0.375000,0.312500,0.125000,0.062500,0.062500,0.187500,0.187500,0.250000,0.187500,0.187500,0.187500,0.187500,0.187500,0.250000,0.125000,0.187500,0.312500,0.125000,0.250000,0.187500,0.125000,0.125000,0.125000,0.187500,0.125000,0.187500,0.187500,0.187500,0.125000,0.250000,0.187500,0.250000,0.187500,0.187500,0.187500,0.187500,0.187500,0.187500,0.187500,0.187500,0.125000,0.187500,0.187500,0.125000,0.187500,0.187500,0.125000,0.187500,0.187500,0.125000,0.187500,0.312500,0.062500,0.062500,0.687500,0.125000,0.250000,0.125000,0.187500,0.187500,0.125000,0.125000,0.125000,0.187500,0.187500,0.187500,0.125000,0.125000,0.125000,0.125000,0.187500,0.125000,0.125000,0.125000,0.125000,0.125000,0.187500,0.125000,0.187500,0.187500,0.125000,0.187500,0.125000,0.125000,0.125000,0.187500,0.187500,0.125000,0.187500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.187500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.062500,0.125000,0.062500,0.062500,0.062500,0.125000,0.062500,0.125000,0.062500,0.062500,0.062500,0.125000,0.062500,0.062500,0.125000,0.125000,0.062500,0.062500,0.062500,0.125000,0.062500,0.062500,0.125000,0.125000,0.062500,0.062500,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.062500,0.125000,0.062500,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.062500,0.062500,0.062500,0.125000,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.062500,0.062500,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.062500,0.062500,0.125000,0.062500,0.062500,0.125000,0.062500,0.062500,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.125000,0.062500,0.062500,0.125000,0.125000,0.062500,0.125000,0.062500,0.062500,0.062500,0.125000,0.125000,0.125000,0.062500,0.062500,0.062500,0.062500,0.062500,0.125000,0.125000,0.125000,0.062500,0.125000,0.062500,0.062500,0.125000,0.125000,0.062500,0.062500,0.125000,0.062500,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.062500,0.062500,0.062500,0.125000,0.062500,0.062500,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.062500,0.125000,0.062500,0.125000,0.125000,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000,0.062500,0.062500,0.062500,0.125000,0.125000,0.125000,0.062500,0.125000,0.125000,0.125000, 0, 0, 0, 0, 0]

print("LENGTH OF VERILOG FFT FIRST HALF: ", len(verilog_magnitudes_first_half))
max_frequencies_verilog_0 = plot_FFT(verilog_magnitudes_first_half, x, "VERILOG FFT FIRST HALF")
print("VERILOG MAX FREQUENCIES FIRST HALF:", max_frequencies_verilog_0)

verilog_magnitudes_second_half = [16383.000000, 16383.000000, 16383.000000, 16383.000000, 12.000000, 1.000000, 38.000000, 7.000000, 2.000000, 1.000000, 18.000000, 11.000000, 8.000000, 8.000000, 0.000000, 3.000000, 2.000000, 0.000000, 1.000000, 48.000000, 2.000000, 3.000000, 13.000000, 0.000000, 10.000000, 1.000000, 4.000000, 1.000000, 0.000000, 0.000000, 1.000000, 1.000000, 0.000000, 0.000000, 27.000000, 82.000000, 3.000000, 0.000000, 26.000000, 0.000000, 4.000000, 0.000000, 31.000000, 5.000000, 0.000000, 4.000000, 1.000000, 0.000000, 1.000000, 0.000000, 33.000000, 7.000000, 4.000000, 0.000000, 10.000000, 0.000000, 1.000000, 5.000000, 8.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 36.000000, 437.000000, 2.000000, 0.000000, 0.000000, 3.000000, 5.000000, 1.000000, 30.000000, 69.000000, 18.000000, 1.000000, 0.000000, 81.000000, 10.000000, 1.000000, 29.000000, 14.000000, 0.000000, 2.000000, 18.000000, 0.000000, 2.000000, 1.000000, 2.000000, 0.000000, 0.000000, 0.000000, 2.000000, 0.000000, 0.000000, 0.000000, 0.000000, 21.000000, 7.000000, 0.000000, 3.000000, 0.000000, 0.000000, 0.000000, 2.000000, 0.000000, 0.000000, 0.000000, 1.000000, 28.000000, 4.000000, 1.000000, 47.000000, 7.000000, 0.000000, 0.000000, 7.000000, 0.000000, 0.000000, 0.000000, 3.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1804.000000, 14.000000, 2.000000, 2.000000, 16.000000, 0.000000, 0.000000, 33.000000, 1.000000, 0.000000, 0.000000, 25.000000, 3.000000, 0.000000, 0.000000, 42.000000, 13.000000, 6.000000, 25.000000, 1.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 24.000000, 10.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 2.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 8.000000, 3.000000, 5.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 6.000000, 107.000000, 0.000000, 0.000000, 2.000000, 0.000000, 0.000000, 0.000000, 3.000000, 2.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 11.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 10.000000, 7163.000000, 5.000000, 0.000000, 1.000000, 1.000000, 0.000000, 0.000000, 2.000000, 0.000000, 4.000000, 1.000000, 3.000000, 1.000000, 0.000000, 0.000000, 6.000000, 8.000000, 9.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 4.000000, 29.000000, 2.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 5.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 2.000000, 2.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 7.000000, 117.000000, 2.000000, 0.000000, 0.000000, 2.000000, 0.000000, 0.000000, 1.000000, 1.000000, 1.000000, 0.000000, 3.000000, 2.000000, 0.000000, 0.000000, 7.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 9.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 333.000000, 0.000000, 1.000000, 4.000000, 0.000000, 0.000000, 0.000000, 6.000000, 1.000000, 0.000000, 0.000000, 2.000000, 0.000000, 0.000000, 0.000000, 28.000000, 23.000000, 7.000000, 11.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 5.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 2.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 27.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 3.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0]

print("LENGTH OF VERILOG FFT SECOND HALF: ", len(verilog_magnitudes_first_half))
max_frequencies_verilog_1 = plot_FFT(verilog_magnitudes_second_half, x, "VERILOG FFT FIRST HALF")
print("VERILOG MAX FREQUENCIES FIRST HALF:", max_frequencies_verilog_1)

plt.show()